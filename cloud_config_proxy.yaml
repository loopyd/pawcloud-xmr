#cloud-config

# Networking configuration
preserve_hostname: false
hostname: pawcloud-proxy

manage_resolv_conf: true

resolv_conf:
  nameservers: ['8.8.4.4', '8.8.8.8']
  searchdomains:
    - ns1.pawcloud.com
    - ns2.pawcloud.com
  domain: pawcloud.com
  options:
    rotate: true
    timeout: 1

# Group and user configuration
groups:
  - ubuntu [root,sys]
  - cloud-users
  
users:
  - default
  - name: nodeproxy
    gecos: PawCloud XMR Proxy User
    home: /home/nodeproxy
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    primary_group: nodeproxy
    groups: cloud-users
    plain_text_passwd: 'pawcloud-proxy1'
    ssh_import_id: None
    lock_passwd: false

# Filesystem configuration
growpart:
    mode: auto
    devices: ["/"]
    ignore_growroot_disabled: false

# Files to write.
write_files:
  - path: /etc/netplan/20-eth0_custom.yaml
    content: |
      network:
        version: 2
        ethernets:
          eth0:
            match:
              name: eth0
            set-name: eth0
            dhcp4: true
            nameservers:
              search: [ns1.local, ns2.local]
              addresses: [8.8.8.8, 8.8.4.4]
  - path: /etc/netplan/21-eth1_custom.yaml
    content: |
      network:
        version: 2
        ethernets:
          eth1:
            match:
              name: eth1
            set-name: eth1
            dhcp4: false
            addresses: [10.0.0.2/24]
  - path: /home/nodeproxy/00_install-proxy.sh
    content: |
      #!/bin/bash
      {
      . ~/.bashrc
      curl -L https://raw.githubusercontent.com/loopyd/xmr-node-proxy/master/install.sh | bash
      } > ~/install-log.txt
      full_path=$(realpath $0)
      rm -f "$full_path"
  - path: /home/nodeproxy/01_install-proxy.sh
    content: |
      #!/bin/bash
      source ~/.profile
      chmod u+x ~/.nvm/nvm.sh
      source ~/.nvm/nvm.sh
      {
      cd ~/xmr-node-proxy
      tee ./config.json >/dev/null <<'EOF'
      {
        "pools": [
          {
            "hostname": "pool.supportxmr.com",
            "port": 3333,
            "ssl": false,
            "allowSelfSignedSSL": false,
            "share": 100,
            "username": "46Z4T9pKPPv82ixGexhGZW9rmMHzPyLnU9ozhewcp8EbC2QagMtz2BKdiqTCx9wo1AiVbEt8R6w1J4ad8W6NpDzRJCxQUMG",
            "password": "proxy:nightwintertooth@gmail.com",
            "keepAlive": true,
            "coin": "xmr",
            "default": true
          }
        ],
        "listeningPorts": [
          {
            "port": 8443,
            "ssl": true,
            "diff": 1000,
            "coin": "xmr"
          },
          {
            "port": 3333,
            "ssl": false,
            "diff": 1000,
            "coin": "xmr"
          },
          {
            "port": 5555,
            "ssl": false,
            "diff": 5000,
            "coin": "xmr"
          },
          {
            "port": 7777,
            "ssl": false,
            "diff": 10000,
            "coin": "xmr"
          }
        ],
        "bindAddress": "0.0.0.0",
        "daemonAddress": "127.0.0.1:18081",
        "coinSettings": {
          "xmr":{
            "minDiff": 100,
            "maxDiff": 300000,
            "shareTargetTime": 15
          }
        }
      }
      EOF
      pm2 start ./proxy.js --name=proxy --log-date-format="YYYY-MM-DD HH:mm Z"
      pm2 save
      } >> ~/install-log.txt
      full_path=$(realpath $0)
      rm -f $full_path

# Package manager
apt_update: true
apt_upgrade: true
apt_reboot_if_required: true

# Commands to run
runcmd:
  - [ netplan, apply ]
  - [ sh, -xc, "cp /etc/skel/.* /home/nodeproxy" ]
  - [ sh, -xc, "chown -R nodeproxy:nodeproxy /home/nodeproxy" ]
  - [ sh, -xc, "chmod +x /home/nodeproxy/00_install-proxy.sh" ]
  - [ sh, -xc, "chmod +x /home/nodeproxy/01_install-proxy.sh" ]
  - [ su, -c, /home/nodeproxy/00_install-proxy.sh, -s, /bin/bash, nodeproxy ]
  - [ su, -, nodeproxy, -c, "~/01_install-proxy.sh" ]